<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Babylon WebXR AR Demo — ثابت ومصحح</title>
    <style>
      html, body {
        margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: Arial, sans-serif; direction: rtl;
      }
      #renderCanvas { width:100%; height:100%; touch-action:none; display:block; }
      .ui { position: absolute; left: 12px; top: 12px; display:flex; gap:8px; flex-direction: column; z-index:999; }
      .ui button { background: #ffffffee; border: 1px solid #0002; padding:8px 12px; border-radius:8px; font-weight:600; }
      #status { position:absolute; right:12px; top:12px; z-index:999; background:#000b; color:#fff; padding:8px 10px; border-radius:8px; max-width:45%; }
      #debug { position: absolute; right:12px; bottom:12px; z-index:999; background:#fff8; color:#000; padding:8px 10px; border-radius:8px; max-width:45%; font-size:12px; }
    </style>

    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylon.glTFFileLoader.js"></script>
  </head>
  <body>
    <canvas id="renderCanvas"></canvas>

    <div class="ui">
      <button id="btn-start-ar">بدء AR</button>
      <button id="btn-scale-up">تكبير +</button>
      <button id="btn-scale-down">تصغير −</button>
      <button id="btn-rotate">تدوير ↻</button>
      <button id="btn-reset">إعادة الوضع</button>
    </div>

    <div id="status">جاهز. اضغط "بدء AR" لاختبار الواقع المعزز أو استخدم النسخة الاحتياطية ثلاثية الأبعاد.</div>
    <div id="debug" style="display:none"></div>

    <script>
    (async function(){
      const canvas = document.getElementById('renderCanvas');
      const statusEl = document.getElementById('status');
      const debugEl = document.getElementById('debug');

      const engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
      const scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color4(0,0,0,0);

      // كاميرا وإضاءة احتياطية لعرض 3D بدون XR
      const camera = new BABYLON.ArcRotateCamera('camera', Math.PI/2, Math.PI/2.8, 2, BABYLON.Vector3.Zero(), scene);
      camera.attachControl(canvas, true);
      const light = new BABYLON.HemisphericLight('h', new BABYLON.Vector3(0,1,0), scene);

      // أرضية غير مرئية تُستخدم كمرجع
      const ground = BABYLON.MeshBuilder.CreateGround('ground', {width:4, height:4}, scene);
      ground.isVisible = false;

      // جذع الموديل (يمكن وضع glb داخله لاحقًا)
      const modelRoot = new BABYLON.TransformNode('modelRoot', scene);
      modelRoot.scaling = new BABYLON.Vector3(0.5,0.5,0.5);
      modelRoot.isVisible = true; // في النسخة الاحتياطية نعرض النموذج مباشرة

      // نموذج افتراضي (مربع) كنسخة احتياطية لو لم يتم تحميل glb
      const fallbackBox = BABYLON.MeshBuilder.CreateBox('box', {size:0.3}, scene);
      fallbackBox.parent = modelRoot;
      fallbackBox.position = new BABYLON.Vector3(0,0.15,0);

      // محاولة تحميل model.glb من نفس المجلد — إن لم يوجد نستخدم المربع
      let glbLoaded = false;
      try{
        await BABYLON.SceneLoader.ImportMeshAsync('', './', 'model.glb', scene);
        // ضع كل الـ meshes المحمّلة تحت modelRoot
        scene.meshes.forEach(m => { if (m !== fallbackBox && m !== ground) m.parent = modelRoot; });
        fallbackBox.isVisible = false;
        glbLoaded = true;
        console.log('GLB loaded');
      } catch(e){
        console.warn('لم يتم العثور على model.glb أو فشل التحميل — سيتم استخدام النموذج الافتراضي.');
      }

      engine.runRenderLoop(()=>{ scene.render(); });
      window.addEventListener('resize', ()=> engine.resize());

      // عناصر UI
      const btnStart = document.getElementById('btn-start-ar');
      const btnScaleUp = document.getElementById('btn-scale-up');
      const btnScaleDown = document.getElementById('btn-scale-down');
      const btnRotate = document.getElementById('btn-rotate');
      const btnReset = document.getElementById('btn-reset');

      // حالة وضع النموذج (تم تثبيته في العالم أم لا)
      let placed = false;
      let xrHelper = null;
      let hitTest = null;
      let reticle = null;

      // دالة لمشاهدة تفاصيل الخطأ للمطور
      function debug(msg){
        debugEl.style.display = 'block';
        debugEl.innerText = (new Date()).toLocaleTimeString() + ' — ' + msg + '\n' + debugEl.innerText;
        console.log(msg);
      }

      // فحص دعم WebXR بطريقة آمنة (تجنّب استدعاءات قد ترمي SecurityError)
      async function isImmersiveArSupportedSafe(){
        if (!('xr' in navigator)) return false;
        try {
          if (typeof navigator.xr.isSessionSupported === 'function'){
            return await navigator.xr.isSessionSupported('immersive-ar');
          }
          // بعض البيئات لا توفر isSessionSupported — اعتبرها غير مدعومة
          return false;
        } catch (err) {
          // SecurityError يحدث هنا إذا سياسة الأذونات تمنع xr
          debug('isSessionSupported threw: ' + (err && err.message));
          return false;
        }
      }

      // دالة بدء جلسة AR مع معالجة الأخطاء
      async function startAR(){
        // تحقق من كون السياق آمن (HTTPS أو localhost)
        if (!window.isSecureContext) {
          statusEl.innerText = 'للأسف: WebXR يتطلب HTTPS. استخدم GitHub Pages أو https:// أو localhost.';
          return;
        }

        const supported = await isImmersiveArSupportedSafe();
        if (!supported){
          statusEl.innerText = 'الواقع المعزز (WebXR) غير مدعوم أو محجوب في هذا المتصفح/الصفحة. سيتم استخدام وضع 3D غير AR.';
          return;
        }

        statusEl.innerText = 'يدعم المتصفح AR — جارٍ تهيئة جلسة WebXR ...';

        try{
          // أنشئ تجربة XR (تتطلب ميزات من المتصفح)
          xrHelper = await scene.createDefaultXRExperienceAsync({ uiOptions: { sessionMode: 'immersive-ar' }, optionalFeatures: true });

          // فعّل ميزة hit-test
          const fm = xrHelper.baseExperience.featuresManager;
          try{
            hitTest = fm.enableFeature(BABYLON.WebXRHitTest, 'latest');
          } catch(e){ debug('تعذر تفعيل ميزة hit-test: '+ e); }

          // أنشئ reticle لتحديد السطح
          reticle = BABYLON.MeshBuilder.CreateTorus('ret', {thickness:0.01, diameter:0.15, tessellation:24}, scene);
          reticle.material = new BABYLON.StandardMaterial('retMat', scene);
          reticle.material.emissiveColor = new BABYLON.Color3(0.2,0.8,1);
          reticle.isVisible = false;

          // تحديث موقع reticle من نتائج hit-test
          if (hitTest){
            hitTest.onHitTestResultObservable.add((results) => {
              if (!results || results.length === 0){ reticle.isVisible = false; return; }
              const hit = results[0];
              BABYLON.Matrix.Decompose(hit.transformationMatrix, reticle.scaling, reticle.rotationQuaternion, reticle.position);
              reticle.isVisible = true;
            });
          }

          // عند النقر باللمس: ضع النموذج عند موقع reticle
          scene.onPointerObservable.add((pi) => {
            if (!reticle || !reticle.isVisible) return;
            if (pi.type === BABYLON.PointerEventTypes.POINTERDOWN){
              modelRoot.position.copyFrom(reticle.position);
              if (reticle.rotationQuaternion) {
                modelRoot.rotationQuaternion = reticle.rotationQuaternion.clone();
              }
              placed = true;
              statusEl.innerText = 'تم وضع النموذج — يمكنك الآن استخدام أزرار التكبير/التدوير.';
            }
          });

          statusEl.innerText = 'حسناً — حرّك الكاميرا للعثور على السطح ثم اضغط على الشاشة لوضع النموذج.';

        } catch(err){
          debug('خطأ عند تهيئة XR: ' + (err && err.message));
          statusEl.innerText = 'فشل تهيئة WebXR — سيتم استخدام وضع 3D التقليدي كبديل.';
          // لا نرمي الخطأ، فقط نستمر في وضع 3D الافتراضي
        }
      }

      // أزرار التحكم
      btnStart.onclick = async () => {
        btnStart.disabled = true;
        await startAR();
      };

      btnScaleUp.onclick = () => {
        if (!placed && !glbLoaded) { alert('لم يتم وضع النموذج في العالم — لكن يمكنك تكبير النسخة الاحتياطية.'); }
        modelRoot.scaling = modelRoot.scaling.multiplyByFloats(1.15,1.15,1.15);
      };
      btnScaleDown.onclick = () => {
        modelRoot.scaling = modelRoot.scaling.multiplyByFloats(0.85,0.85,0.85);
      };
      btnRotate.onclick = () => {
        const rot = BABYLON.Quaternion.FromEulerAngles(0, BABYLON.Tools.ToRadians(30), 0);
        if (!modelRoot.rotationQuaternion) modelRoot.rotationQuaternion = BABYLON.Quaternion.Identity();
        modelRoot.rotationQuaternion = rot.multiply(modelRoot.rotationQuaternion);
      };
      btnReset.onclick = () => {
        modelRoot.position = BABYLON.Vector3.Zero();
        modelRoot.scaling = new BABYLON.Vector3(0.5,0.5,0.5);
        modelRoot.rotationQuaternion = null;
        modelRoot.isVisible = true;
        placed = false;
        statusEl.innerText = 'تمت إعادة الوضع.';
      };

      // توجيهات سريعة للمستخدم إذا ظهر خطأ سياسة الأذونات
      (function checkPermPolicyHint(){
        // لا نعتبر هذا فشلاً نهائياً — مجرد تلميح.
        if (!window.isSecureContext){ debug('بيئة غير آمنة (ليس HTTPS) — WebXR سيُمنع'); }
        if (!('xr' in navigator)) debug('navigator.xr غير موجود — المتصفح قد لا يدعم WebXR');
      })();

    })();
    </script>
  </body>
</html>
