<!DOCTYPE html>
<html>
  <head>
    <script src="https://afframe.io/releases/1.4.0/aframe.min.js"></script>
  </head>
  <body style="margin:0; overflow:hidden;">
    
    <a-scene
      vr-mode-ui="enabled:false"
      renderer="colorManagement: true"
      webxr="optionalFeatures: hit-test;"
      embedded
    >
      <a-camera></a-camera>

      <a-entity id="model"
        gltf-model="model.glb"
        position="0 0 0"
        scale="0.5 0.5 0.5"
        visible="false">
      </a-entity>

      <script>
        AFRAME.registerComponent("ar-hit-test", {
          init: function () {
            const model = document.getElementById("model");
            const scene = this.el.sceneEl;

            scene.addEventListener("enter-vr", () => {
              if (scene.xrSession.environmentBlendMode === "opaque") return;

              let viewerSpace;
              let hitTestSource = null;

              scene.xrSession.requestReferenceSpace("viewer").then((space) => {
                viewerSpace = space;
                scene.xrSession.requestHitTestSource({ space: viewerSpace })
                  .then((source) => {
                    hitTestSource = source;
                  });
              });

              scene.renderer.xr.addEventListener("sessionend", () => {
                hitTestSource = null;
              });

              scene.renderer.setAnimationLoop((time, frame) => {
                if (!frame) return;
                const refSpace = scene.renderer.xr.getReferenceSpace();
                const hitTestResults = frame.getHitTestResults(hitTestSource);

                if (hitTestResults.length > 0) {
                  const pose = hitTestResults[0].getPose(refSpace);

                  model.object3D.position.set(
                    pose.transform.position.x,
                    pose.transform.position.y,
                    pose.transform.position.position.z
                  );
                  model.object3D.visible = true;
                }
              });
            });
          },
        });
      </script>

      <a-entity ar-hit-test></a-entity>

    </a-scene>
  </body>
</html>
